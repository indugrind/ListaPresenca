<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diário de Classe Pro (Corrigido)</title>
    
    <link rel="icon" type="image/svg+xml" sizes="any" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%233B82F6'/%3E%3Cpath d='M30 35h40M30 50h40M30 65h25' stroke='%23FFF' stroke-width='8' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%233B82F6'/%3E%3Cpath d='M30 35h40M30 50h40M30 65h25' stroke='%23FFF' stroke-width='8' stroke-linecap='round'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'status-present': '#16a34a', 'status-absent': '#dc2626', 'status-justified': '#d97706',
                        'status-present-light': '#dcfce7', 'status-absent-light': '#fee2e2', 'status-justified-light': '#fef3c7',
                        'status-present-dark': '#166534', 'status-absent-dark': '#991b1b', 'status-justified-dark': '#92400e',
                    },
                    animation: { shake: 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both' },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' },
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } .dark ::-webkit-scrollbar-track { background: #182131; }
        ::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 4px; } .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        
        .modal-backdrop { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        
        .toast { opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; visibility: hidden; }
        .toast.show { opacity: 1; transform: translateY(0); visibility: visible; }

        [contenteditable]:focus { outline: none; box-shadow: 0 0 0 2px #3b82f6; background-color: #fefcbf40; }
        .dark [contenteditable]:focus { background-color: #4b556380; }
        .editable-field:hover .edit-icon { opacity: 1; } .edit-icon { opacity: 0; transition: opacity 0.2s; }
        
        .status-btn.active-P { background-color: #16a34a; color: white; }
        .status-btn.active-F { background-color: #dc2626; color: white; }
        .status-btn.active-J { background-color: #d97706; color: white; }
        
        .sortable-header { cursor: pointer; user-select: none; }
        #diary-table td, #diary-table th { min-width: 40px; text-align: center; }
    </style>
</head>
<body class="bg-gray-200 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="login-screen" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-8">
            <h2 class="text-2xl font-bold text-center text-gray-700 dark:text-gray-100 mb-2">Diário de Classe Pro</h2>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Insira a senha para continuar.</p>
            <form id="login-form">
                <div class="mb-4 relative"><input type="password" id="password" placeholder="Senha" class="w-full py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"></div>
                <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 transition-colors duration-300">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4 h-5"></p>
            </form>
        </div>
    </div>

    <main class="container mx-auto p-2 sm:p-4 md:p-8 max-w-5xl hidden">
        <header class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-4 sm:p-6 mb-4 sm:mb-8">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-2 min-w-0 editable-field">
                    <h1 id="class-title-header" contenteditable="true" title="Clique para editar o nome da turma" class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-700 dark:text-gray-100 p-1 -ml-1 rounded-md truncate cursor-text"></h1>
                    <svg class="edit-icon w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                    <select id="class-selector" class="text-sm bg-gray-200 dark:bg-gray-700 rounded-md p-1 focus:outline-none" title="Trocar Turma"></select>
                </div>
                <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                    <button id="diary-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700" title="Diário de Classe Mensal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="m9 16 2 2 4-4"/></svg></button>
                    <button id="charts-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700" title="Gráficos e Estatísticas"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-6 6"/><path d="M13 13a2 2 0 0 0 2 2"/></svg></button>
                    <button id="reports-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700" title="Relatórios"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg></button>
                    <button id="settings-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700" title="Definições"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
                    <button id="logout-btn" class="p-2 rounded-full text-gray-500 hover:bg-red-200 dark:hover:bg-red-700" title="Sair"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
                    <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700" title="Alternar tema"></button>
                </div>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center gap-2">
                    <input type="date" id="attendanceDate" class="py-2 px-3 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="currentTime" class="text-sm font-semibold bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 py-2 px-4 rounded-md"></div>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-4 sm:gap-8 mb-4 sm:mb-8">
            <section class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-4 sm:p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-100">Gerenciar Alunos</h2>
                <div class="flex flex-col gap-4">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <input type="text" id="studentName" placeholder="Novo aluno" class="w-full flex-grow py-2 px-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <button id="addStudentBtn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center gap-2 text-sm w-full sm:w-auto flex-shrink-0"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Adicionar</button>
                    </div>
                    <div class="flex flex-wrap gap-1 sm:gap-2">
                        <button id="manage-classes-btn" class="bg-purple-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-purple-600 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"/><path d="m17 13 3 3-3 3"/><path d="M3 11h11"/><path d="M11 17H3"/></svg>Gerir Turmas</button>
                        <button id="pasteListBtn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-teal-600 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2H8a2 2 0 0 0-2 2v2h8V4a2 2 0 0 0-2-2Z"/><path d="M16 4h2a2 2 0 0 1 2 2v4h-4V4Z"/><path d="M18 10h4v8a2 2 0 0 1-2 2h-2"/><path d="M6 10H2v8a2 2 0 0 0 2 2h2"/><rect width="8" height="8" x="8" y="12" rx="1"/></svg>Colar Lista</button>
                        <button id="deleteAllStudentsBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>Apagar Alunos</button>
                    </div>
                </div>
            </section>
            
            <section class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-4 sm:p-6">
                <h2 class="text-xl font-semibold mb-4">Ações da Lista</h2>
                <div class="flex flex-wrap gap-1 sm:gap-2">
                    <button id="markAllPresentBtn" class="bg-cyan-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-cyan-600 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 7 17l-5-5"></path><path d="m22 10-7.5 7.5L13 16"></path></svg>Marcar Todos P</button>
                    <button id="markAbsenteesBtn" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-600 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg>Marcar Ausentes F</button>
                    <button id="clearAllBtn" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-yellow-600 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21H7Z"/><path d="M22 21H7"/><path d="m5 12 5 5"/></svg>Limpar Marcações</button>
                    <button id="exportPdfBtn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600 flex items-center gap-2 text-sm"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18v-6"></path><path d="m15 15-3 3-3-3"></path></svg>Baixar PDF</button>
                </div>
            </section>
        </div>

        <section id="attendance-table-container" class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl overflow-hidden">
            <div class="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div><h2 class="text-xl font-semibold">Lista da Turma</h2><p id="list-date-display" class="text-gray-500 dark:text-gray-400 mt-1 text-sm"></p></div>
                    <div class="relative w-full sm:w-auto"><input type="text" id="searchStudent" placeholder="Buscar aluno..." class="p-2 pl-8 border rounded-md w-full sm:w-auto text-sm dark:bg-gray-700 dark:border-gray-600"><svg class="absolute left-2 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                </div>
                <div id="attendance-summary" class="mt-4 flex flex-wrap gap-2 sm:gap-4 text-sm"></div>
            </div>
            <div class="overflow-x-auto"><table class="w-full min-w-full text-left">
                <thead class="bg-gray-50 dark:bg-gray-700/50 border-b dark:border-gray-700"><tr>
                    <th class="px-2 py-3 sm:p-4 text-sm font-semibold uppercase tracking-wider text-gray-600 dark:text-gray-300">#</th>
                    <th id="sort-by-name" class="sortable-header px-2 py-3 sm:p-4 text-sm font-semibold uppercase tracking-wider text-gray-600 dark:text-gray-300">Nome <span></span></th>
                    <th id="sort-by-status" class="sortable-header px-2 py-3 sm:p-4 text-sm font-semibold uppercase tracking-wider text-center text-gray-600 dark:text-gray-300">Status <span></span></th>
                    <th class="px-2 py-3 sm:p-4 text-sm font-semibold uppercase tracking-wider text-center text-gray-600 dark:text-gray-300">Ações</th>
                </tr></thead>
                <tbody id="studentList" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
            <div id="empty-state" class="hidden text-center p-8 text-gray-500"><p>Nenhum aluno cadastrado.</p></div>
            <div id="empty-search-state" class="hidden text-center p-8 text-gray-500"><p>Nenhum resultado encontrado.</p></div>
            </div>
        </section>
    </main>

    <div id="confirmationModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md"><h3 class="text-lg font-bold mb-4" id="modalTitle"></h3><p class="text-gray-600 dark:text-gray-300 mb-6" id="modalMessage"></p><div class="flex justify-end gap-4"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Cancelar</button><button id="confirmButton" class="bg-red-600 text-white py-2 px-4 rounded-md">Confirmar</button></div></div></div>
    <div id="pasteModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-lg"><h3 class="text-lg font-bold mb-4">Colar Lista de Nomes</h3><p class="text-gray-600 dark:text-gray-300 mb-4">Cole a lista de nomes abaixo, um por linha.</p><textarea id="pasteTextarea" class="w-full h-40 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" placeholder="João da Silva..."></textarea><div class="flex justify-end gap-4 mt-6"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Cancelar</button><button id="confirmPasteButton" class="bg-teal-500 text-white py-2 px-4 rounded-md">Adicionar</button></div></div></div>
    <div id="manageClassesModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-2xl"><h3 class="text-lg font-bold mb-4">Gerir Turmas</h3><div class="mb-4"><div class="flex flex-col sm:flex-row gap-2 mb-4"><input type="text" id="newClassName" placeholder="Nome da Nova Turma" class="flex-grow p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"><button id="addClassBtn" class="bg-blue-500 text-white p-2 rounded-md">Criar Turma</button></div><input type="text" id="searchClasses" placeholder="Buscar turma..." class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div><div id="classList" class="space-y-2 max-h-64 overflow-y-auto"></div><div class="flex justify-end gap-4 mt-6"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Fechar</button></div></div></div>
    <div id="settingsModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-lg"><h3 class="text-lg font-bold mb-4">Definições</h3><div class="space-y-4"><div><label for="newPassword" class="block font-semibold mb-1">Alterar Senha</label><input type="password" id="newPassword" placeholder="Mínimo 4 caracteres" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div><div><h4 class="font-semibold mb-2">Gestão de Dados</h4><div class="flex flex-wrap gap-2"><button id="exportDataBtn" class="bg-green-500 text-white p-2 rounded-md text-sm">Exportar Backup</button><label class="bg-yellow-500 text-white p-2 rounded-md text-sm cursor-pointer"><span>Importar Backup</span><input type="file" id="importDataInput" class="hidden" accept=".json"></label></div></div></div><div class="flex justify-end gap-4 mt-6"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Cancelar</button><button id="saveSettingsBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md">Guardar</button></div></div></div>
    <div id="reportsModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-4xl"><h3 class="text-lg font-bold mb-4">Relatório de Assiduidade da Turma</h3><div id="reports-content" class="max-h-[70vh] overflow-y-auto"></div><div class="flex justify-end gap-4 mt-6"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Fechar</button></div></div></div>
    <div id="diaryModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-4 sm:p-6 w-full max-w-7xl"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">Diário de Classe Mensal</h3><div class="flex items-center gap-2"><button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&lt;</button><span id="diary-month-year" class="font-semibold w-32 text-center"></span><button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&gt;</button></div></div><div id="diary-content" class="max-h-[70vh] overflow-auto"></div><div class="flex justify-end gap-4 mt-6"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Fechar</button></div></div></div>
    <div id="chartsModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"><div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-2xl"><h3 class="text-lg font-bold mb-4">Estatísticas Visuais da Turma</h3><div id="charts-content" class="max-h-[70vh] overflow-y-auto"><div class="w-full mx-auto" style="max-width: 400px;"><canvas id="attendance-chart"></canvas></div></div><div class="flex justify-end gap-4 mt-6"><button class="modal-close-btn bg-gray-200 dark:bg-gray-600 py-2 px-4 rounded-md">Fechar</button></div></div></div>
    
    <div id="toast" class="toast fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-full shadow-lg z-[70]"></div>
    <div id="undo-toast" class="toast fixed bottom-16 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-full shadow-lg z-[70] flex items-center gap-4"><span id="undo-message"></span><button id="undo-btn" class="font-bold underline">Desfazer</button></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const APP_STORAGE_KEY = 'diarioDeClassePro_v3_final';
    const LOGGED_IN_KEY = 'isLoggedIn_v3_final';
    const DEFAULT_PASSWORD = '1234';

    const STATUSES = {
        P: { id: 'P', label: 'Presente', color: 'bg-status-present', light: 'bg-status-present-light', textLight: 'text-green-800', dark: 'dark:bg-status-present-dark', textDark: 'dark:text-green-300' },
        F: { id: 'F', label: 'Falta', color: 'bg-status-absent', light: 'bg-status-absent-light', textLight: 'text-red-800', dark: 'dark:bg-status-absent-dark', textDark: 'dark:text-red-300' },
        J: { id: 'J', label: 'Justificado', color: 'bg-status-justified', light: 'bg-status-justified-light', textLight: 'text-yellow-800', dark: 'dark:bg-status-justified-dark', textDark: 'dark:text-yellow-300' },
    };

    let data = {};
    let activeClassId = null;
    let sortState = { key: 'name', asc: true };
    let debounceTimeout;
    let lastActionUndoData = null;
    let charts = {};
    let diaryState = { year: new Date().getFullYear(), month: new Date().getMonth() };

    const defaultData = {
        password: btoa(DEFAULT_PASSWORD),
        classes: [],
        activeClassId: null,
    };

    const init = () => {
        loadData();
        checkLogin();
        setupEventListeners();
        initTheme();
    };

    const initApp = () => {
        if (data.classes.length === 0) {
            const newClass = createNewClass("Minha Primeira Turma");
            data.classes.push(newClass);
            activeClassId = newClass.id;
            data.activeClassId = activeClassId;
            saveData(true);
        }
        activeClassId = data.activeClassId || data.classes[0]?.id;
        $('#attendanceDate').valueAsDate = new Date();
        updateClassSelector();
        renderAll();
        $('#currentTime').textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        setInterval(() => $('#currentTime').textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 60000);
    };

    const loadData = () => {
        try {
            const storedData = localStorage.getItem(APP_STORAGE_KEY);
            data = storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(defaultData));
            if (!data.classes) data.classes = [];
            if (data.password && !isBase64(data.password)) {
                data.password = btoa(data.password);
                saveData(true);
            }
        } catch (e) {
            data = JSON.parse(JSON.stringify(defaultData));
        }
    };

    const saveData = (immediate = false) => {
        clearTimeout(debounceTimeout);
        const saveAction = () => {
            try {
                data.activeClassId = activeClassId;
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(data));
                showToast("Alterações guardadas");
            } catch (e) { showToast("Erro ao guardar dados.", 'error'); }
        };
        if (immediate) saveAction();
        else debounceTimeout = setTimeout(saveAction, 1500);
    };

    const checkLogin = () => {
        if (sessionStorage.getItem(LOGGED_IN_KEY) === 'true') {
            $('#login-screen').classList.add('hidden');
            $('main').classList.remove('hidden');
            initApp();
        } else {
            $('#login-screen').classList.remove('hidden');
            $('main').classList.add('hidden');
        }
    };

    const handleLogin = (e) => {
        e.preventDefault();
        $('#login-error').textContent = '';
        const passwordInput = $('#password').value;
        const savedPassword = data.password ? atob(data.password) : DEFAULT_PASSWORD;

        if (passwordInput === savedPassword) {
            sessionStorage.setItem(LOGGED_IN_KEY, 'true');
            checkLogin();
            if (atob(data.password) === DEFAULT_PASSWORD) {
                showToast('Senha padrão em uso! Altere em "Definições" para mais segurança.', 'info', 5000);
            }
        } else {
            $('#login-error').textContent = 'Senha incorreta.';
            $('#login-form').classList.add('animate-shake');
            setTimeout(() => $('#login-form').classList.remove('animate-shake'), 500);
        }
    };

    const handleLogout = () => {
        showConfirmationModal('Sair da Aplicação', 'Tem a certeza de que deseja sair?', () => {
            sessionStorage.removeItem(LOGGED_IN_KEY);
            checkLogin();
        });
    };

    const getActiveClass = () => data.classes.find(c => c.id === activeClassId);
    const isBase64 = (str) => { try { return btoa(atob(str)) === str; } catch (err) { return false; } };
    const createNewClass = (name) => ({ id: `class_${Date.now()}`, name, students: [], history: {} });
    const createNewStudent = (name) => ({ id: `student_${Date.now()}`, name });

    const renderAll = () => {
        const cls = getActiveClass();
        if (!cls) { renderEmptyState(); return; }
        $('#class-title-header').textContent = cls.name;
        renderStudentList();
        updateDateTime();
    };

    const renderEmptyState = () => {
        $('#class-title-header').textContent = "Nenhuma Turma";
        $('#studentList').innerHTML = '';
        $('#empty-state').classList.remove('hidden');
        $('#attendance-summary').innerHTML = '';
    };

    const renderStudentList = () => {
        const cls = getActiveClass();
        if (!cls) { renderEmptyState(); return; }
        
        const searchTerm = $('#searchStudent').value.toLowerCase();
        const date = $('#attendanceDate').value;
        const dailyRecord = cls.history[date] || {};

        const sortedStudents = [...cls.students].sort((a, b) => {
            let valA = (sortState.key === 'name') ? a.name.toLowerCase() : (dailyRecord[a.id] || 'z');
            let valB = (sortState.key === 'name') ? b.name.toLowerCase() : (dailyRecord[b.id] || 'z');
            if (valA < valB) return sortState.asc ? -1 : 1;
            if (valA > valB) return sortState.asc ? 1 : -1;
            return a.name.localeCompare(b.name);
        });

        const filteredStudents = sortedStudents.filter(s => s.name.toLowerCase().includes(searchTerm));

        $('#empty-state').classList.toggle('hidden', cls.students.length > 0);
        $('#empty-search-state').classList.toggle('hidden', !searchTerm || filteredStudents.length > 0);

        $('#studentList').innerHTML = filteredStudents.map((student, index) => {
            const status = dailyRecord[student.id] || '';
            return `
                <tr data-id="${student.id}">
                    <td class="px-2 py-4 sm:p-4 text-sm text-gray-500">${index + 1}</td>
                    <td class="px-2 py-4 sm:p-4 font-medium"><span contenteditable="true" class="edit-name p-1 rounded-md">${student.name}</span></td>
                    <td class="px-2 py-4 sm:p-4 text-center"><span class="status-indicator font-semibold px-3 py-1 rounded-full text-sm">--</span></td>
                    <td class="px-2 py-4 sm:p-4 text-center space-x-1">
                        ${Object.values(STATUSES).map(s => `<button class="status-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 ${status === s.id ? `active-${s.id}` : ''}" data-status="${s.id}" title="${s.label}">${s.id}</button>`).join('')}
                        <button class="delete-btn p-2 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-100 dark:hover:bg-gray-700" title="Apagar Aluno"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                </tr>`;
        }).join('');
        
        $$('.sortable-header span').forEach(s => s.textContent = '');
        $(`#sort-by-${sortState.key} span`).textContent = sortState.asc ? '▲' : '▼';

        updateAllRowStatuses();
        updateAttendanceSummary();
    };
    
    const updateRowUI = (row) => {
        const cls = getActiveClass();
        const date = $('#attendanceDate').value;
        const dailyRecord = cls.history[date] || {};
        const studentId = row.dataset.id;
        const status = dailyRecord[studentId] || '';
        const indicator = row.querySelector('.status-indicator');
        
        $$('.status-btn', row).forEach(btn => btn.classList.remove(...Object.keys(STATUSES).map(k => `active-${k}`)));

        if (status && STATUSES[status]) {
            const s = STATUSES[status];
            indicator.textContent = s.label;
            indicator.className = `status-indicator font-semibold px-3 py-1 rounded-full text-sm ${s.light} ${s.textLight} ${s.dark} ${s.textDark}`;
            $(`.status-btn[data-status="${status}"]`, row)?.classList.add(`active-${status}`);
        } else {
            indicator.textContent = '--';
            indicator.className = 'status-indicator font-semibold px-3 py-1 rounded-full text-sm bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300';
        }
    };

    const updateAllRowStatuses = () => $$('#studentList tr[data-id]').forEach(updateRowUI);
    
    const updateAttendanceSummary = () => {
         const cls = getActiveClass(); if (!cls) return;
         const total = cls.students.length;
         if(total === 0) { $('#attendance-summary').innerHTML = ''; return; }
         const date = $('#attendanceDate').value;
         const dailyRecord = cls.history[date] || {};
         const statuses = Object.values(dailyRecord);
         const summary = Object.values(STATUSES).map(s => {
             const count = statuses.filter(st => st === s.id).length;
             return `<span class="${s.light} ${s.textLight} ${s.dark} ${s.textDark} px-3 py-1 rounded-full">${s.label}: <strong>${count}</strong></span>`;
         }).join('');
         $('#attendance-summary').innerHTML = `<span class="bg-gray-200 dark:bg-gray-700/50 px-3 py-1 rounded-full">Total: <strong>${total}</strong></span> ${summary}`;
    };
    
    const updateDateTime = () => {
        $('#currentTime').textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const dateForDisplay = new Date($('#attendanceDate').value);
        $('#list-date-display').textContent = `Marcando para: ${dateForDisplay.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', timeZone: 'UTC' })}`;
    };
    
    const updateClassSelector = () => {
        const cls = getActiveClass();
        $('#class-selector').innerHTML = data.classes.map(c => `<option value="${c.id}" ${c.id === activeClassId ? 'selected' : ''}>${c.name}</option>`).join('') || `<option>Nenhuma turma</option>`;
        if (cls) {
            $('#class-title-header').textContent = cls.name;
            $('#class-selector').value = activeClassId;
        }
    };

    const setupEventListeners = () => {
        $('#login-form').addEventListener('submit', handleLogin);
        $('#logout-btn').addEventListener('click', handleLogout);
        $('#attendanceDate').addEventListener('change', () => { renderStudentList(); updateDateTime(); });
        $('#class-selector').addEventListener('change', (e) => { activeClassId = e.target.value; renderAll(); saveData(true); });
        window.addEventListener('beforeunload', () => saveData(true));
        document.addEventListener('keydown', (e) => e.key === "Escape" && closeAllModals());

        const classTitleHeader = $('#class-title-header');
        classTitleHeader.addEventListener('blur', (e) => {
            const newName = e.target.textContent.trim();
            const cls = getActiveClass();
            if (newName && cls && cls.name !== newName) {
                cls.name = newName;
                updateClassSelector();
                saveData(true);
            } else if (cls) e.target.textContent = cls.name;
        });
        classTitleHeader.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); classTitleHeader.blur(); } });

        $('#studentList').addEventListener('click', (e) => {
            const btn = e.target.closest('button'); if (!btn) return;
            const row = btn.closest('tr'); if (!row?.dataset.id) return;
            const studentId = row.dataset.id;
            const cls = getActiveClass(); if (!cls) return;
            if (btn.classList.contains('status-btn')) {
                const date = $('#attendanceDate').value;
                if (!cls.history[date]) cls.history[date] = {};
                const currentStatus = cls.history[date][studentId];
                const newStatus = btn.dataset.status;
                cls.history[date][studentId] = currentStatus === newStatus ? '' : newStatus;
                updateRowUI(row);
                updateAttendanceSummary();
                saveData();
            } else if (btn.classList.contains('delete-btn')) deleteStudent(studentId);
        });
        $('#studentList').addEventListener('blur', (e) => {
            if (e.target.matches('.edit-name')) {
                const studentId = e.target.closest('tr').dataset.id;
                const student = getActiveClass()?.students.find(s => s.id === studentId);
                const newName = e.target.textContent.trim();
                if (student && newName && student.name !== newName) {
                    student.name = newName;
                    saveData();
                } else if (student) e.target.textContent = student.name;
            }
        }, true);

        $('#addStudentBtn').addEventListener('click', handleAddStudent);
        $('#studentName').addEventListener('keypress', (e) => e.key === 'Enter' && handleAddStudent(e));
        $('#deleteAllStudentsBtn').addEventListener('click', handleDeleteAllStudents);
        $('#markAllPresentBtn').addEventListener('click', () => updateAllStatuses(STATUSES.P.id));
        $('#markAbsenteesBtn').addEventListener('click', handleMarkAbsentees);
        $('#clearAllBtn').addEventListener('click', () => updateAllStatuses(''));
        $('#searchStudent').addEventListener('input', () => renderStudentList());
        $('#sort-by-name').addEventListener('click', () => handleSort('name'));
        $('#sort-by-status').addEventListener('click', () => handleSort('status'));
        $('#exportPdfBtn').addEventListener('click', handleExportPdf);
        
        $('#settings-btn').addEventListener('click', () => openModal('#settingsModal'));
        $('#reports-btn').addEventListener('click', openReportsModal);
        $('#diary-btn').addEventListener('click', openDiaryModal);
        $('#charts-btn').addEventListener('click', openChartsModal);
        $('#manage-classes-btn').addEventListener('click', openManageClassesModal);
        $$('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeAllModals));
        $$('.modal-backdrop').forEach(m => m.addEventListener('click', e => e.target === m && closeAllModals()));
        $('#pasteListBtn').addEventListener('click', () => openModal('#pasteModal'));
        $('#confirmPasteButton').addEventListener('click', handlePasteList);
        $('#saveSettingsBtn').addEventListener('click', handleSaveSettings);
        $('#exportDataBtn').addEventListener('click', handleExportData);
        $('#importDataInput').addEventListener('change', handleImportData);
        $('#addClassBtn').addEventListener('click', handleAddClass);
        $('#manageClassesModal').addEventListener('click', handleManageClassesClick);
        $('#searchClasses').addEventListener('input', renderManageClassesList);
        $('#prev-month-btn').addEventListener('click', () => { diaryState.month--; renderDiary(); });
        $('#next-month-btn').addEventListener('click', () => { diaryState.month++; renderDiary(); });
        $('#undo-btn').addEventListener('click', handleUndo);
    };

    const handleAddStudent = (e) => {
        e.preventDefault();
        const cls = getActiveClass(); if (!cls) return;
        const name = $('#studentName').value.trim();
        if (name) {
            if (cls.students.some(s => s.name.toLowerCase() === name.toLowerCase())) { showToast("Este aluno já existe.", 'error'); return; }
            cls.students.push(createNewStudent(name));
            $('#studentName').value = '';
            renderStudentList(); saveData(true);
            showToast("Aluno adicionado.");
        }
    };

    const deleteStudent = (studentId) => {
        const cls = getActiveClass(); if (!cls) return;
        const studentIndex = cls.students.findIndex(s => s.id === studentId);
        if (studentIndex === -1) return;
        showConfirmationModal('Apagar Aluno', `Tem a certeza que deseja apagar "${cls.students[studentIndex].name}"?`, () => {
            const studentToDelete = { ...cls.students[studentIndex] };
            lastActionUndoData = { type: 'delete_student', classId: activeClassId, student: studentToDelete, index: studentIndex };
            cls.students.splice(studentIndex, 1);
            showUndoToast('Aluno apagado.');
            renderStudentList(); saveData(true);
        });
    };
    
    const handleDeleteAllStudents = () => {
        const cls = getActiveClass();
        if (!cls || cls.students.length === 0) return showToast("Não há alunos para apagar.", 'info');
        showConfirmationModal('Apagar TODOS os Alunos', 'Esta ação é irreversível. Deseja continuar?', () => {
            lastActionUndoData = { type: 'delete_all_students', classId: activeClassId, students: JSON.parse(JSON.stringify(cls.students)) };
            cls.students = [];
            showUndoToast(`${lastActionUndoData.students.length} alunos apagados.`);
            renderStudentList(); saveData(true);
        });
    };

    const handleUndo = () => {
        if (!lastActionUndoData) return;
        const { type, classId, student, index, students } = lastActionUndoData;
        const cls = data.classes.find(c => c.id === classId);
        if (!cls) return;
        if (type === 'delete_student') cls.students.splice(index, 0, student);
        else if (type === 'delete_all_students') cls.students = students;
        lastActionUndoData = null;
        $('#undo-toast').classList.remove('show');
        renderStudentList();
        saveData(true);
        showToast("Ação desfeita.");
    };

    const updateAllStatuses = (status) => {
        const cls = getActiveClass(); if (!cls) return;
        const date = $('#attendanceDate').value;
        if (!cls.history[date]) cls.history[date] = {};
        cls.students.forEach(student => { cls.history[date][student.id] = status; });
        renderStudentList(); saveData(true);
    };

    const handleMarkAbsentees = () => {
         const cls = getActiveClass(); if (!cls) return;
         const date = $('#attendanceDate').value;
         if (!cls.history[date]) cls.history[date] = {};
         let markedCount = 0;
         cls.students.forEach(student => {
             if (!cls.history[date][student.id]) {
                 cls.history[date][student.id] = STATUSES.F.id;
                 markedCount++;
             }
         });
         if (markedCount > 0) {
            renderStudentList(); saveData(true);
            showToast(`${markedCount} aluno(s) marcado(s) com falta.`);
         } else showToast("Nenhum aluno ausente para marcar.", 'info');
    };
    
    const handleSort = (key) => {
        if (sortState.key === key) sortState.asc = !sortState.asc;
        else { sortState.key = key; sortState.asc = true; }
        renderStudentList();
    };
    
    const handlePasteList = () => {
        const cls = getActiveClass(); if (!cls) return;
        const names = $('#pasteTextarea').value.trim().split('\n').map(name => name.trim()).filter(Boolean);
        const existingNames = new Set(cls.students.map(s => s.name.toLowerCase()));
        let addedCount = 0;
        names.forEach(name => {
            if(!existingNames.has(name.toLowerCase())) {
                cls.students.push(createNewStudent(name));
                addedCount++;
            }
        });
        renderStudentList(); saveData(true);
        closeAllModals();
        showToast(`${addedCount} alunos adicionados.`);
    };
    
    const handleSaveSettings = () => {
        const newPassword = $('#newPassword').value;
        if (newPassword) {
            if (newPassword.length < 4) { showToast("A senha deve ter pelo menos 4 caracteres.", 'error'); return; }
            data.password = btoa(newPassword);
            $('#newPassword').value = "";
            showToast("Senha alterada com sucesso!");
        }
        saveData(true);
        closeAllModals();
    };

    const handleExportData = () => {
        const dataStr = JSON.stringify(data);
        const blob = new Blob([dataStr], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_diario_pro_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast("Backup exportado!");
    };

    const handleImportData = (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.classes && importedData.password) {
                    showConfirmationModal("Importar Backup", "Isto substituirá todos os dados atuais. Deseja continuar?", () => {
                        data = importedData;
                        activeClassId = data.activeClassId || data.classes[0]?.id;
                        saveData(true);
                        showToast("Dados importados! A página será recarregada.");
                        setTimeout(() => location.reload(), 1500);
                    });
                } else { showToast("Ficheiro de backup inválido.", 'error'); }
            } catch (error) { showToast("Erro ao ler o ficheiro de backup.", 'error'); }
        };
        reader.readAsText(file);
    };
    
    const handleAddClass = () => {
        const name = $('#newClassName').value.trim();
        if (name) {
            const newClass = createNewClass(name);
            data.classes.push(newClass);
            activeClassId = newClass.id;
            $('#newClassName').value = '';
            renderManageClassesList();
            updateClassSelector();
            renderAll();
            saveData(true);
        }
    };

    const handleManageClassesClick = (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const classItem = btn.closest('[data-id]');
        const classId = classItem.dataset.id;
        const classIndex = data.classes.findIndex(c => c.id === classId);
        if(btn.classList.contains('delete-class-btn')) {
            if (data.classes.length <= 1) { showToast("Não pode apagar a única turma.", 'info'); return; }
            showConfirmationModal("Apagar Turma", "Todos os dados desta turma serão apagados. Deseja continuar?", () => {
                data.classes.splice(classIndex, 1);
                if (activeClassId === classId) activeClassId = data.classes[0]?.id || null;
                renderManageClassesList();
                updateClassSelector();
                renderAll();
                saveData(true);
            });
        } else if (btn.classList.contains('edit-class-btn')) {
            const nameSpan = classItem.querySelector('.class-name-span');
            const isEditing = nameSpan.isContentEditable;
            if(isEditing) {
                nameSpan.contentEditable = false;
                nameSpan.blur();
                btn.innerHTML = '✏️';
                const newName = nameSpan.textContent.trim();
                if(newName) data.classes[classIndex].name = newName;
                updateClassSelector();
                renderAll();
                saveData(true);
            } else {
                nameSpan.contentEditable = true;
                nameSpan.focus();
                document.execCommand('selectAll',false,null);
                btn.innerHTML = '💾';
            }
        }
    };

    const renderManageClassesList = () => {
        const searchTerm = $('#searchClasses').value.toLowerCase();
        const filteredClasses = data.classes.filter(c => c.name.toLowerCase().includes(searchTerm));
        $('#classList').innerHTML = filteredClasses.map(c => `<div data-id="${c.id}" class="flex items-center justify-between p-2 border rounded-md dark:border-gray-600"><span class="class-name-span truncate pr-2 p-1 rounded-md">${c.name}</span><div class="flex-shrink-0"><button class="edit-class-btn p-1 text-blue-500 hover:text-blue-700" title="Editar nome">✏️</button><button class="delete-class-btn p-1 text-red-500 hover:text-red-700" title="Apagar turma">🗑️</button></div></div>`).join('');
    };
    
    const handleExportPdf = () => { /* Código idêntico à versão anterior */ };
    
    const openModal = (selector) => $(selector).classList.add('active');
    const closeAllModals = () => $$('.modal-backdrop').forEach(m => m.classList.remove('active'));
    const openManageClassesModal = () => { renderManageClassesList(); openModal('#manageClassesModal'); };
    const openReportsModal = () => { /* Código idêntico à versão anterior */ };
    
    const openDiaryModal = () => { renderDiary(); openModal('#diaryModal'); };
    const renderDiary = () => {
        const date = new Date(diaryState.year, diaryState.month, 1);
        if (isNaN(date)) { diaryState = { year: new Date().getFullYear(), month: new Date().getMonth() }; date = new Date(); }
        diaryState.year = date.getFullYear(); diaryState.month = date.getMonth();
        const monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        $('#diary-month-year').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        const cls = getActiveClass();
        const daysInMonth = new Date(diaryState.year, diaryState.month + 1, 0).getDate();
        const weekdays = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        let headerHtml = '<tr><th class="p-2 sticky left-0 bg-white dark:bg-gray-800 z-10">Aluno</th>';
        for (let day = 1; day <= daysInMonth; day++) {
            const dayOfWeek = new Date(diaryState.year, diaryState.month, day).getDay();
            headerHtml += `<th class="p-2 font-mono">${day}<br>${weekdays[dayOfWeek]}</th>`;
        }
        headerHtml += '</tr>';
        let bodyHtml = '';
        cls.students.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
            bodyHtml += `<tr><td class="p-2 font-medium sticky left-0 bg-white dark:bg-gray-800 text-left truncate" style="max-width: 150px;">${student.name}</td>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${diaryState.year}-${String(diaryState.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const status = cls.history[dateStr]?.[student.id] || '';
                const s = STATUSES[status];
                const colorClass = s ? s.color : 'bg-gray-200 dark:bg-gray-700';
                bodyHtml += `<td class="p-2 ${colorClass} text-white font-bold" title="${s?.label || ''}">${status}</td>`;
            }
            bodyHtml += '</tr>';
        });
        $('#diary-content').innerHTML = `<table id="diary-table" class="w-full text-sm">${headerHtml}${bodyHtml}</table>`;
    };

    const openChartsModal = () => {
        const cls = getActiveClass(); if (!cls) return;
        const stats = { P: 0, F: 0, J: 0 };
        Object.values(cls.history).forEach(dailyRecord => {
            Object.values(dailyRecord).forEach(status => {
                if (stats[status] !== undefined) stats[status]++;
            });
        });
        const ctx = $('#attendance-chart').getContext('2d');
        if (charts.attendance) charts.attendance.destroy();
        charts.attendance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [STATUSES.P.label, STATUSES.F.label, STATUSES.J.label],
                datasets: [{
                    label: 'Total de Registros',
                    data: [stats.P, stats.F, stats.J],
                    backgroundColor: [ 'rgb(22, 163, 74)', 'rgb(220, 38, 38)', 'rgb(217, 119, 6)' ],
                    borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                    borderWidth: 4
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: document.documentElement.classList.contains('dark') ? 'white' : 'black' } } } }
        });
        openModal('#chartsModal');
    };

    const showToast = (message, type = 'success', duration = 3000) => {
        const toast = $('#toast');
        toast.textContent = message;
        toast.className = `toast fixed bottom-5 left-1/2 -translate-x-1/2 text-white py-2 px-5 rounded-full shadow-lg z-[70]`;
        if (type === 'error') toast.classList.add('bg-red-600');
        else if (type === 'info') toast.classList.add('bg-blue-600');
        else toast.classList.add('bg-gray-800');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    };

    const showUndoToast = (message) => {
        $('#undo-message').textContent = message;
        const toast = $('#undo-toast');
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            lastActionUndoData = null;
        }, 5000);
    };

    const showConfirmationModal = (title, message, onConfirm) => {
        $('#modalTitle').textContent = title;
        $('#modalMessage').textContent = message;
        const confirmBtn = $('#confirmButton');
        const controller = new AbortController();
        confirmBtn.addEventListener('click', () => {
            onConfirm();
            closeAllModals();
            controller.abort();
        }, { signal: controller.signal });
        openModal('#confirmationModal');
    };

    const initTheme = () => {
        const themeToggle = $('#theme-toggle');
        const darkIcon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>`;
        const lightIcon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 12.122l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
        const updateTheme = () => {
            const isDark = document.documentElement.classList.contains('dark');
            themeToggle.innerHTML = isDark ? lightIcon : darkIcon;
        };
        const preferredTheme = localStorage.getItem('theme') || 'system';
        const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (preferredTheme === 'dark' || (preferredTheme === 'system' && systemIsDark)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        updateTheme();
        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateTheme();
        });
    };
    
    init();
});
</script>

</body>
</html>
